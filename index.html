<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>3×3 – Generador, Predicción y Clasificación</title>
    <!-- Tailwind CSS por CDN (rápido para prototipo) -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- React 18 UMD + ReactDOM 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel standalone para poder usar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tu app: versión JS sin TypeScript ni imports -->
    <script type="text/babel">
      const { useMemo, useState } = React;

      function App3x3VR() {
        const [names, setNames] = useState(["", "", "", "", "", ""]);
        const [started, setStarted] = useState(false);
        const [matches, setMatches] = useState([]);
        const [currentIdx, setCurrentIdx] = useState(0);
        const [scoreA, setScoreA] = useState("");
        const [scoreB, setScoreB] = useState("");
        const [activeTab, setActiveTab] = useState("jugadores"); // "jugadores" | "partido" | "clasificacion"

        const allPlayersValid = useMemo(() => {
          const cleaned = names.map((n) => n.trim());
          if (cleaned.some((n) => n.length === 0)) return false;
          const lower = cleaned.map((n) => n.toLowerCase());
          return new Set(lower).size === 6;
        }, [names]);

        function handleStart() {
          if (!allPlayersValid) return;
          const m = generateUniqueMatches();
          const shuffled = shuffle([...m]);
          setMatches(shuffled);
          setStarted(true);
          setCurrentIdx(0);
          setActiveTab("partido");
        }

        function generateUniqueMatches() {
          const idx = [0, 1, 2, 3, 4, 5];
          const combos = [];
          for (let a = 0; a < 4; a++) {
            for (let b = a + 1; b < 5; b++) {
              for (let c = b + 1; c < 6; c++) {
                combos.push([idx[a], idx[b], idx[c]]);
              }
            }
          }
          const out = [];
          for (const teamA of combos) {
            const teamB = idx.filter((i) => !teamA.includes(i));
            if (Math.min(...teamA) < Math.min(...teamB)) {
              out.push({ teamA: [...teamA], teamB: [...teamB] });
            }
          }
          return out; // 10 partidos
        }

        function shuffle(arr) {
          for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
          }
          return arr;
        }

        const standings = useMemo(() => {
          const pts = Array(6).fill(0);
          const pj = Array(6).fill(0);
          matches.forEach((m) => {
            if (m.result) {
              m.teamA.forEach((p) => (pj[p] += 1));
              m.teamB.forEach((p) => (pj[p] += 1));
              if (m.result === "A") {
                m.teamA.forEach((p) => (pts[p] += 2));
              } else if (m.result === "B") {
                m.teamB.forEach((p) => (pts[p] += 2));
              } else {
                m.teamA.forEach((p) => (pts[p] += 1));
                m.teamB.forEach((p) => (pts[p] += 1));
              }
            }
          });
          return { pts, pj };
        }, [matches]);

        const prediction = useMemo(() => {
          if (!started || currentIdx >= matches.length) return null;
          const m = matches[currentIdx];
          const prior = 1;
          const rating = (i) => prior + standings.pts[i];
          const sumA = m.teamA.reduce((acc, i) => acc + rating(i), 0);
          const sumB = m.teamB.reduce((acc, i) => acc + rating(i), 0);
          const diff = sumA - sumB;
          const probA = 1 / (1 + Math.exp(-diff / 2));
          let label;
          if (Math.abs(diff) < 0.75) label = "Partido muy igualado";
          else label = diff > 0 ? "Favorito: Equipo A" : "Favorito: Equipo B";
          return { sumA, sumB, probA, probB: 1 - probA, label };
        }, [started, currentIdx, matches, standings]);

        function submitScore() {
          if (currentIdx >= matches.length) return;
          const a = parseInt(scoreA, 10);
          const b = parseInt(scoreB, 10);
          if (Number.isNaN(a) || Number.isNaN(b)) return;
          const next = [...matches];
          const m = { ...next[currentIdx] };
          m.scoreA = a;
          m.scoreB = b;
          m.result = a > b ? "A" : a < b ? "B" : "D";
          next[currentIdx] = m;
          setMatches(next);
          setScoreA("");
          setScoreB("");
          if (currentIdx + 1 < next.length) {
            setCurrentIdx((i) => i + 1);
            setActiveTab("partido");
          } else {
            setCurrentIdx(next.length);
            setActiveTab("clasificacion");
          }
        }

        function undoLast() {
          if (currentIdx === 0) return;
          const idx = currentIdx - 1;
          const next = [...matches];
          next[idx] = { ...next[idx], scoreA: undefined, scoreB: undefined, result: undefined };
          setMatches(next);
          setCurrentIdx(idx);
          setActiveTab("partido");
        }

        function resetAll() {
          setStarted(false);
          setMatches([]);
          setCurrentIdx(0);
          setScoreA("");
          setScoreB("");
          setActiveTab("jugadores");
        }

        const remaining = started ? matches.slice(currentIdx) : [];
        const finished  = started ? matches.slice(0, currentIdx) : [];

        const playerRows = useMemo(() => {
          return names
            .map((n, i) => ({
              name: n.trim() || `J${i + 1}`,
              pts: standings.pts[i] || 0,
              pj: standings.pj[i] || 0,
              ppp: (standings.pj[i] || 0) > 0 ? (standings.pts[i] / standings.pj[i]).toFixed(2) : "-",
            }))
            .sort((a, b) => b.pts - a.pts || a.name.localeCompare(b.name));
        }, [names, standings]);

        const TabButton = ({ id, label }) => (
          <button
            onClick={() => setActiveTab(id)}
            className={`px-4 py-2 rounded-xl border text-sm font-medium transition ${
              activeTab === id
                ? "bg-indigo-600 text-white border-indigo-600"
                : "bg-white text-slate-700 border-slate-300 hover:bg-slate-50"
            }`}
          >
            {label}
          </button>
        );

        return (
          <div className="min-h-screen bg-slate-50 text-slate-900 p-6">
            <div className="max-w-5xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-2xl shadow p-5 mb-4">
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                  <div>
                    <h1 className="text-2xl font-bold">3×3 – Generador, Predicción y Clasificación</h1>
                    <p className="text-sm text-slate-600">Introduce jugadores, juega los 10 partidos 3v3 y consulta predicciones y ranking.</p>
                  </div>
                  <div className="flex gap-2">
                    <TabButton id="jugadores" label="Jugadores" />
                    <TabButton id="partido" label="Partido y Predicción" />
                    <TabButton id="clasificacion" label="Clasificación" />
                  </div>
                </div>
              </div>

              {/* Jugadores */}
              {activeTab === "jugadores" && (
                <div className="bg-white rounded-2xl shadow p-5">
                  <h2 className="text-xl font-semibold mb-4">Introducir jugadores</h2>
                  <div className="space-y-3">
                    {names.map((val, i) => (
                      <div key={i} className="flex items-center gap-2">
                        <span className="w-6 text-slate-500">{i + 1}.</span>
                        <input
                          className="flex-1 rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          placeholder={`Jugador ${i + 1}`}
                          value={val}
                          onChange={(e) => {
                            const next = [...names];
                            next[i] = e.target.value;
                            setNames(next);
                          }}
                        />
                      </div>
                    ))}
                    <div className="flex items-center justify-between text-xs text-slate-500">
                      <div>Partidos totales: {matches.length || 10} · Jugados: {finished.length} · Pendientes: {started ? remaining.length : 10}</div>
                      <div className="flex gap-2">
                        <button onClick={resetAll} className="rounded-xl px-3 py-2 bg-slate-100 hover:bg-slate-200 border">Reiniciar</button>
                        <button
                          onClick={handleStart}
                          disabled={!allPlayersValid}
                          className={`rounded-xl px-4 py-2 font-semibold ${
                            allPlayersValid
                              ? "bg-indigo-600 hover:bg-indigo-700 text-white"
                              : "bg-slate-300 text-slate-500 cursor-not-allowed"
                          }`}
                        >
                          Generar calendario y empezar
                        </button>
                      </div>
                    </div>
                    {!allPlayersValid && (
                      <p className="text-xs text-amber-600 mt-2">
                        Introduce los 6 nombres (sin repetir) para continuar.
                      </p>
                    )}
                  </div>
                </div>
              )}

              {/* Partido */}
              {activeTab === "partido" && (
                <div className="bg-white rounded-2xl shadow p-5">
                  <h2 className="text-xl font-semibold mb-4">Partido en curso</h2>
                  {!started || currentIdx >= matches.length ? (
                    <div className="text-slate-600">
                      {!started ? "Aún no has iniciado la sesión" : "No quedan partidos pendientes. 🎉"}
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {(() => {
                        const m = matches[currentIdx];
                        const teamA = m.teamA.map((i) => names[i]);
                        const teamB = m.teamB.map((i) => names[i]);
                        return (
                          <>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div className="rounded-xl border p-4">
                                <div className="uppercase text-xs text-slate-500 mb-1">Equipo A</div>
                                <ul className="list-disc ml-5">
                                  {teamA.map((n, i) => (
                                    <li key={i}>{n}</li>
                                  ))}
                                </ul>
                              </div>
                              <div className="rounded-xl border p-4">
                                <div className="uppercase text-xs text-slate-500 mb-1">Equipo B</div>
                                <ul className="list-disc ml-5">
                                  {teamB.map((n, i) => (
                                    <li key={i}>{n}</li>
                                  ))}
                                </ul>
                              </div>
                            </div>

                            {prediction && (
                              <div className="rounded-xl bg-indigo-50 border border-indigo-200 p-4">
                                <div className="text-sm font-semibold mb-1">Predicción del resultado (modelo sencillo)</div>
                                <div className="text-sm">{prediction.label}</div>
                                <div className="text-xs text-slate-600 mt-1">Prob. A: {(prediction.probA * 100).toFixed(1)}% · Prob. B: {(prediction.probB * 100).toFixed(1)}%</div>
                                <div className="text-xs text-slate-500">Fuerza A: {prediction.sumA.toFixed(2)} · Fuerza B: {prediction.sumB.toFixed(2)} (prior = 1 + puntos acumulados)</div>
                              </div>
                            )}

                            <div className="flex items-end gap-3">
                              <div className="flex-1">
                                <label className="text-xs uppercase text-slate-500">Puntos equipo A</label>
                                <input
                                  type="number"
                                  min={0}
                                  value={scoreA}
                                  onChange={(e) => setScoreA(e.target.value)}
                                  className="w-full rounded-xl border px-3 py-2"
                                />
                              </div>
                              <div className="flex-1">
                                <label className="text-xs uppercase text-slate-500">Puntos equipo B</label>
                                <input
                                  type="number"
                                  min={0}
                                  value={scoreB}
                                  onChange={(e) => setScoreB(e.target.value)}
                                  className="w-full rounded-xl border px-3 py-2"
                                />
                              </div>
                              <button
                                onClick={submitScore}
                                className="rounded-xl px-4 py-2 bg-indigo-600 text-white font-semibold hover:bg-indigo-700"
                              >
                                Guardar resultado
                              </button>
                            </div>

                            <div className="flex gap-2">
                              <button onClick={() => setActiveTab("jugadores")} className="rounded-xl px-3 py-2 border">Editar jugadores</button>
                              <button onClick={() => setActiveTab("clasificacion")} className="rounded-xl px-3 py-2 border">Ver clasificación</button>
                              <button onClick={undoLast} disabled={currentIdx === 0} className={`rounded-xl px-3 py-2 border ${currentIdx===0?"bg-slate-100 text-slate-400 cursor-not-allowed":"bg-white hover:bg-slate-50"}`}>Deshacer último</button>
                              <button onClick={resetAll} className="rounded-xl px-3 py-2 bg-slate-100 hover:bg-slate-200 border">Reiniciar</button>
                            </div>
                          </>
                        );
                      })()}
                    </div>
                  )}
                </div>
              )}

              {/* Clasificación */}
              {activeTab === "clasificacion" && (
                <div className="space-y-6">
                  <div className="bg-white rounded-2xl shadow p-5">
                    <h2 className="text-xl font-semibold mb-4">Clasificación individual</h2>
                    {started ? (
                      <div className="overflow-x-auto">
                        <table className="min-w-full text-sm">
                          <thead>
                            <tr className="text-left text-slate-600">
                              <th className="py-2">Jugador</th>
                              <th className="py-2">Pts</th>
                              <th className="py-2">PJ</th>
                              <th className="py-2">Pts/PJ</th>
                            </tr>
                          </thead>
                          <tbody>
                            {playerRows.map((r, i) => (
                              <tr key={i} className="border-t">
                                <td className="py-2 font-medium">{r.name}</td>
                                <td className="py-2">{r.pts}</td>
                                <td className="py-2">{r.pj}</td>
                                <td className="py-2">{r.ppp}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <p className="text-slate-600 text-sm">Empieza la sesión para ver la clasificación en vivo.</p>
                    )}
                    <div className="mt-4 flex gap-2">
                      <button onClick={() => setActiveTab("partido")} className="rounded-xl px-3 py-2 border">Volver al partido</button>
                      <button onClick={resetAll} className="rounded-xl px-3 py-2 bg-slate-100 hover:bg-slate-200 border">Reiniciar</button>
                    </div>
                  </div>

                  {/* Historial */}
                  {started && (
                    <div className="bg-white rounded-2xl shadow p-5">
                      <h2 className="text-xl font-semibold mb-4">Historial de partidos</h2>
                      <div className="grid gap-3 md:grid-cols-2">
                        {matches.map((m, idx) => (
                          <div key={idx} className={`rounded-xl border p-3 ${idx < currentIdx ? "bg-emerald-50 border-emerald-200" : "bg-slate-50"}`}>
                            <div className="text-xs text-slate-500 mb-1">Partido {idx + 1}</div>
                            <div className="text-sm">
                              <span className="font-semibold">A</span>: {m.teamA.map((i) => names[i]).join(", ")}<br />
                              <span className="font-semibold">B</span>: {m.teamB.map((i) => names[i]).join(", ")}
                            </div>
                            {typeof m.scoreA === "number" && typeof m.scoreB === "number" ? (
                              <div className="mt-2 text-sm">
                                Marcador: <span className="font-semibold">{m.scoreA} - {m.scoreB}</span> ({m.result === "A" ? "Gana A" : m.result === "B" ? "Gana B" : "Empate"})
                              </div>
                            ) : (
                              <div className="mt-2 text-xs text-slate-500">Pendiente</div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App3x3VR />);
    </script>
  </body>
</html>
